<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>网络管理(ConnectivityService) | 美丽的风景往往隐藏在道路的尽头</title><meta name="keywords" content="网络管理,Android"><meta name="author" content="Jack Ou"><meta name="copyright" content="Jack Ou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="本文叙述Android原生网络管理逻辑，已经结合项目中Tbox接入网络管理.">
<meta property="og:type" content="article">
<meta property="og:title" content="网络管理(ConnectivityService)">
<meta property="og:url" content="https://oujie123.github.io/2021/04/08/%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-ConnectivityService/index.html">
<meta property="og:site_name" content="美丽的风景往往隐藏在道路的尽头">
<meta property="og:description" content="本文叙述Android原生网络管理逻辑，已经结合项目中Tbox接入网络管理.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13838098-fac72f45f8246f49.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2021-04-08T06:52:40.000Z">
<meta property="article:modified_time" content="2021-04-22T11:06:52.009Z">
<meta property="article:author" content="Jack Ou">
<meta property="article:tag" content="网络管理">
<meta property="article:tag" content="ConnectivityService">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/13838098-fac72f45f8246f49.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><link rel="shortcut icon" href="https://upload-images.jianshu.io/upload_images/13838098-8a5cd66eafd7c761.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><link rel="canonical" href="https://oujie123.github.io/2021/04/08/%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-ConnectivityService/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Jack Ou","link":"链接: ","source":"来源: 美丽的风景往往隐藏在道路的尽头","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-22 19:06:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://upload-images.jianshu.io/upload_images/13838098-a7dfe0e9d3ed649c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">64</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分栏</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://upload-images.jianshu.io/upload_images/13838098-fac72f45f8246f49.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">美丽的风景往往隐藏在道路的尽头</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分栏</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">网络管理(ConnectivityService)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-08T06:52:40.000Z" title="发表于 2021-04-08 14:52:40">2021-04-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-22T11:06:52.009Z" title="更新于 2021-04-22 19:06:52">2021-04-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Framework/">Framework</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="1-网络管理概览"><a href="#1-网络管理概览" class="headerlink" title="1.网络管理概览"></a>1.网络管理概览</h3><p>​    Android中提供的数据业务方式有几种：移动数据网络，WIFI，热点，网线等。这些数据业务本身可以独立使用，但是同一时刻，只能使用其中的一种数据业务方式。管理这些数据业务方式的使用由ConnectivityService，NetworkFactory，NetworkAgent，NetworkMonitor等来完成，ConnectivityService处于核心调度位置。</p>
<p>​    在公司项目中,引入了Tbox和车内以太网。这两类网络上网的方式主要替代原生的移动数据网络和以太网。</p>
<p>​    ConnectivityService主要和以下四个模块交互来完成网络管理：</p>
<ul>
<li>网络有效性检测（NetworkMonitor） </li>
<li>网络评分机制（NetworkFactory） </li>
<li>路由配置信息的获取（NetworkAgent） </li>
<li>网络物理端口的设置（Netd）</li>
</ul>
<p><strong>Android网络管理架构如下图所示</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/13838098-f4b58a927db33e96.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Android网络管理.png"></p>
<p>当Android数据业务服务可用时，会将自己(NetworkFactory和NetworkAgent)注册到ConnectivityService中统一管理，ConnectivityService通过ping网络来检查网络的有效性(AOSP中的网址是墙外的网址，极有可能ping不通，因此项目中应该修改此网址，否则可能会导致期望的网络得不到上网权限)，进而影响到各个数据业务方式的评分值，ConnectivityService通过这些评分值来决定以哪个数据业务方式连接网络。决定好数据业务方式后，把这些路由配置信息设置到网络物理设备中。这样我们的手机就可以正常上网了。</p>
<h3 id="2-各个服务的初始化"><a href="#2-各个服务的初始化" class="headerlink" title="2.各个服务的初始化"></a>2.各个服务的初始化</h3><h4 id="2-1-1-ConnectivityService的初始化"><a href="#2-1-1-ConnectivityService的初始化" class="headerlink" title="2.1.1 ConnectivityService的初始化"></a>2.1.1 ConnectivityService的初始化</h4><p>ConnectivityService属于系统服务，在SystemServer中被启动。</p>
<p>SystemServer启动系统核心服务分为三个阶段:</p>
<ul>
<li>启动引导服务，包含AMS PMS DMS PKMS等</li>
<li>启动核心服务：DropBox，Battery,UsageStats,WebViewUpdate等</li>
<li>启动其他服务：InputManagerService，WindowManagerService，ConnectivityService等</li>
</ul>
<p>咱们的主角ConnectivityService就是在其他服务中被启动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// 设置时区</span></span><br><span class="line">        String timezoneProperty =  SystemProperties.get(<span class="string">&quot;persist.sys.timezone&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (timezoneProperty == <span class="keyword">null</span> || timezoneProperty.isEmpty()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Timezone not set; setting to GMT.&quot;</span>);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.timezone&quot;</span>, <span class="string">&quot;GMT&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// 设置语言，国家等等</span></span><br><span class="line">        <span class="keyword">if</span> (!SystemProperties.get(<span class="string">&quot;persist.sys.language&quot;</span>).isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String languageTag = Locale.getDefault().toLanguageTag();</span><br><span class="line"></span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.locale&quot;</span>, languageTag);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.language&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.country&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.localevar&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Here we go!</span></span><br><span class="line">        Slog.i(TAG, <span class="string">&quot;Entered the Android system server!&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">		<span class="comment">//此处省略部分主要干了清理更多内存出来为初始化服务做准备，设置后台任务，增加binder最大线程等</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Prepare the main looper thread (this thread).</span></span><br><span class="line">        android.os.Process.setThreadPriority(</span><br><span class="line">            android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">        android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize native services.</span></span><br><span class="line">        System.loadLibrary(<span class="string">&quot;android_servers&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize the system context.</span></span><br><span class="line">        <span class="comment">//创建android上下文</span></span><br><span class="line">        createSystemContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the system service manager.</span></span><br><span class="line">        mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">        mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);</span><br><span class="line">        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">        <span class="comment">// Prepare the thread pool for init tasks that can be parallelized</span></span><br><span class="line">        SystemServerInitThreadPool.get();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd();  <span class="comment">// InitBeforeStartServices</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start services.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartServices&quot;</span>);</span><br><span class="line">        <span class="comment">//开始启动服务了   ,这个方法是启动引导服务 例如AMS PMS DMS PKMS</span></span><br><span class="line">        startBootstrapServices();</span><br><span class="line">        <span class="comment">//启动核心服务：DropBox，Battery,UsageStats,WebViewUpdate</span></span><br><span class="line">        startCoreServices();</span><br><span class="line">        <span class="comment">//启动其他服务</span></span><br><span class="line">        startOtherServices();</span><br><span class="line">        SystemServerInitThreadPool.shutdown();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">       ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop forever.</span></span><br><span class="line">    <span class="comment">//systemServer一直循环</span></span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Context context = mSystemContext;</span><br><span class="line">        VibratorService vibrator = <span class="keyword">null</span>;</span><br><span class="line">        IStorageManager storageManager = <span class="keyword">null</span>;</span><br><span class="line">        NetworkManagementService networkManagement = <span class="keyword">null</span>;</span><br><span class="line">        NetworkStatsService networkStats = <span class="keyword">null</span>;</span><br><span class="line">        NetworkPolicyManagerService networkPolicy = <span class="keyword">null</span>;</span><br><span class="line">        ConnectivityService connectivity = <span class="keyword">null</span>;</span><br><span class="line">        NetworkScoreService networkScore = <span class="keyword">null</span>;</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化NetworkManagementService</span></span><br><span class="line">        <span class="keyword">if</span> (!disableNetwork) &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">&quot;StartNetworkManagementService&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                networkManagement = NetworkManagementService.create(context);</span><br><span class="line">                ServiceManager.addService(Context.NETWORKMANAGEMENT_SERVICE, networkManagement);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">&quot;starting NetworkManagement Service&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            traceEnd();</span><br><span class="line">        &#125;</span><br><span class="line">   		 ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化NetworkStatsService</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartNetworkStatsService&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            networkStats = NetworkStatsService.create(context, networkManagement);</span><br><span class="line">            ServiceManager.addService(Context.NETWORK_STATS_SERVICE, networkStats);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">&quot;starting NetworkStats Service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        traceEnd();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 初始化NetworkPolicyManagerService</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartNetworkPolicyManagerService&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            networkPolicy = <span class="keyword">new</span> NetworkPolicyManagerService(context,</span><br><span class="line">                              mActivityManagerService, networkStats, networkManagement);</span><br><span class="line">            ServiceManager.addService(Context.NETWORK_POLICY_SERVICE, networkPolicy);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">&quot;starting NetworkPolicy Service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        traceEnd();</span><br><span class="line">            </span><br><span class="line">    	<span class="comment">// 初始化ConnectivityService</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartConnectivityService&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectivity = <span class="keyword">new</span> ConnectivityService(</span><br><span class="line">                context, networkManagement, networkStats, networkPolicy);</span><br><span class="line">            ServiceManager.addService(Context.CONNECTIVITY_SERVICE, connectivity);</span><br><span class="line">            networkStats.bindConnectivityManager(connectivity);</span><br><span class="line">            networkPolicy.bindConnectivityManager(connectivity);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">&quot;starting Connectivity Service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        traceEnd();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化ConnectivityService的时候传入networkManagement，networkStats，networkPolicy。</p>
<h4 id="2-1-2-获取其他服务的接口"><a href="#2-1-2-获取其他服务的接口" class="headerlink" title="2.1.2 获取其他服务的接口"></a>2.1.2 获取其他服务的接口</h4><p>ConnectivityService构造方法中接收交互服务的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mNetd = checkNotNull(netManager, <span class="string">&quot;missing INetworkManagementService&quot;</span>);</span><br><span class="line">mStatsService = checkNotNull(statsService, <span class="string">&quot;missing INetworkStatsService&quot;</span>);</span><br><span class="line">mPolicyManager = checkNotNull(policyManager, <span class="string">&quot;missing INetworkPolicyManager&quot;</span>);</span><br><span class="line">mPolicyManagerInternal = checkNotNull(</span><br><span class="line">LocalServices.getService(NetworkPolicyManagerInternal.class),</span><br><span class="line"><span class="string">&quot;missing NetworkPolicyManagerInternal&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建mTethering</span></span><br><span class="line">mTethering = <span class="keyword">new</span> Tethering(mContext, mNetd, statsService, mPolicyManager,</span><br><span class="line">IoThread.get().getLooper(), <span class="keyword">new</span> MockableSystemProperties());</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册其他必要的监听和广播，以便接收变化信息和通知变化信息。</span></span><br><span class="line">IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">intentFilter.addAction(Intent.ACTION_USER_STARTED);</span><br><span class="line">intentFilter.addAction(Intent.ACTION_USER_STOPPED);</span><br><span class="line">intentFilter.addAction(Intent.ACTION_USER_ADDED);</span><br><span class="line">intentFilter.addAction(Intent.ACTION_USER_REMOVED);</span><br><span class="line">intentFilter.addAction(Intent.ACTION_USER_UNLOCKED);</span><br><span class="line">mContext.registerReceiverAsUser(</span><br><span class="line">    mUserIntentReceiver, UserHandle.ALL, intentFilter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">mContext.registerReceiverAsUser(mUserPresentReceiver, UserHandle.SYSTEM,</span><br><span class="line">    <span class="keyword">new</span> IntentFilter(Intent.ACTION_USER_PRESENT), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向netd注册mTethering</span></span><br><span class="line">mNetd.registerObserver(mTethering);</span><br><span class="line">mNetd.registerObserver(mDataActivityObserver);</span><br></pre></td></tr></table></figure>


<h4 id="2-2-NetworkFactory的初始化"><a href="#2-2-NetworkFactory的初始化" class="headerlink" title="2.2  NetworkFactory的初始化"></a>2.2  NetworkFactory的初始化</h4><p>NetworkFactory负责构建新增网络默认评分，网络类型，网络能力。为了车机启动起来就能按照网络评分机制来选择网络，ConnectivityService服务起来之后，就不断收集外部注册进来的网络(本文用Tbox注册网络和wifi注册网络来叙述)。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13838098-44f70a21b2d72c27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NetworkFactory初始化.png"></p>
<p>当管理Tbox的service起来之后，通过获取usb0(tbox通过usb0与车机通信)配置信息(usb0;12,13,14,15;ip=2.2.2.1/24 gateway=2.2.2.2 dns=116.116.116.116,8.8.8.8;0;70)。然后解析配置信息，解析获取网卡信息之后，创建一个NetworkFactory最后调用register()方法，将该网卡注册到ConnectivityService中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NetworkFactory.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.log(<span class="string">&quot;Registering NetworkFactory&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mMessenger == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">this</span>);</span><br><span class="line">        ConnectivityManager.from(<span class="keyword">this</span>.mContext).registerNetworkFactory(<span class="keyword">this</span>.mMessenger, </span><br><span class="line">                                                                       <span class="keyword">this</span>.LOG_TAG);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConnectivityService.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerNetworkFactory</span><span class="params">(Messenger messenger, String name)</span> </span>&#123;</span><br><span class="line">    enforceConnectivityInternalPermission();</span><br><span class="line">    NetworkFactoryInfo nfi = <span class="keyword">new</span> NetworkFactoryInfo(name, messenger, <span class="keyword">new</span> AsyncChannel());</span><br><span class="line">    mHandler.sendMessage(mHandler.obtainMessage(EVENT_REGISTER_NETWORK_FACTORY, nfi));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//处理EVENT_REGISTER_NETWORK_FACTORY</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleRegisterNetworkFactory</span><span class="params">(NetworkFactoryInfo nfi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DBG) log(<span class="string">&quot;Got NetworkFactory Messenger for &quot;</span> + nfi.name);</span><br><span class="line">    mNetworkFactoryInfos.put(nfi.messenger, nfi);</span><br><span class="line">    <span class="comment">//通过asyncChannel通知Networkfactory操作成功</span></span><br><span class="line">    <span class="comment">//注意，在异步回复Networkfactory的时候，asyncChannel会处理CMD_CHANNEL_HALF_CONNECTED来通知创建NetworkAgent</span></span><br><span class="line">    nfi.asyncChannel.connect(mContext, mTrackerHandler, nfi.messenger);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="2-3-NetworkAgent的初始化"><a href="#2-3-NetworkAgent的初始化" class="headerlink" title="2.3 NetworkAgent的初始化"></a>2.3 NetworkAgent的初始化</h4><p>NetworkAgent是一个网络代理，它里面保存了一些路由的配置信息，比如NetworkInfo，LinkProperties，NetworkCapabilities等。NetworkAgent的初始化都是在路由配置信息获取成功之后。比如打开数据开关，打开wifi开关等操作之后。</p>
<p>注：<br>NetworkInfo 描述一个给定类型的网络接口的状态方面的信息，包括网络连接状态、网络类型、网络可连接性、是否漫游等信息<br>LinkProperties 描述一个网络连接属性信息（包含网络地址、网关、DNS、HTTP代理等属性信息<br>NetworkCapabilities 描述一个网络连接能力方面的信息，包括带宽、延迟等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理CMD_CHANNEL_HALF_CONNECTED </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">maybeHandleAsyncChannelMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">         <span class="keyword">case</span> AsyncChannel.CMD_CHANNEL_HALF_CONNECTED: &#123;</span><br><span class="line">             <span class="comment">// 向NetworkFactory发送路由配置成功了，可以创建NetworkAgent代理了。</span></span><br><span class="line">             handleAsyncChannelHalfConnect(msg);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">        ......</span><br><span class="line"> &#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleAsyncChannelHalfConnect</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    AsyncChannel ac = (AsyncChannel) msg.obj;</span><br><span class="line">    <span class="keyword">if</span> (mNetworkFactoryInfos.containsKey(msg.replyTo)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.arg1 == AsyncChannel.STATUS_SUCCESSFUL) &#123;</span><br><span class="line">            <span class="keyword">if</span> (VDBG) log(<span class="string">&quot;NetworkFactory connected&quot;</span>);</span><br><span class="line">            <span class="comment">// A network factory has connected.  Send it all current NetworkRequests.</span></span><br><span class="line">            <span class="keyword">for</span> (NetworkRequestInfo nri : mNetworkRequests.values()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nri.request.isListen()) <span class="keyword">continue</span>;</span><br><span class="line">                NetworkAgentInfo nai = mNetworkForRequestId.get(nri.request.requestId);</span><br><span class="line">                <span class="comment">// 向NetworkFactory发送CMD_REQUEST_NETWORK请求处理</span></span><br><span class="line">                ac.sendMessage(android.net.NetworkFactory.CMD_REQUEST_NETWORK,</span><br><span class="line">                               (nai != <span class="keyword">null</span> ? nai.getCurrentScore() : <span class="number">0</span>), <span class="number">0</span>, nri.request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            loge(<span class="string">&quot;Error connecting NetworkFactory&quot;</span>);</span><br><span class="line">            mNetworkFactoryInfos.remove(msg.obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NetworkFactory.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_REQUEST_NETWORK: &#123;</span><br><span class="line">            handleAddRequest((NetworkRequest) msg.obj, msg.arg1, msg.arg2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当路由信息配置成功之后，ConnectivityService会通知NetworkFactory创建NetworkAgent。在handleAddRequest方法中会调用evalRequest根据评分，网络能力等来判断是否需要创建代理。</p>
<p><strong>调用链路：</strong>handleAddRequest() –&gt; evalRequest() –&gt;  needNetworkFor() –&gt;  NetworkFactory.startNetwork()–&gt; ExtNetworkFactory.startNetwork() –&gt; mayStartIpManager() –&gt; startIpManager() –&gt;  new NetworkAgent()</p>
<h4 id="2-4-NetworkMonitor的初始化"><a href="#2-4-NetworkMonitor的初始化" class="headerlink" title="2.4 NetworkMonitor的初始化"></a>2.4 NetworkMonitor的初始化</h4><p>NetworkMonitor主要是检测网络有效性的，通过Http封装类去ping一个网站，根据ping网站的结果来影响评分值。因此，它的初始化是在NetworkAgent初始化之后，必须要获取到路由配置信息NetworkAgent后才会去初始化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建NetworkAgent</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NetworkAgent</span><span class="params">(Looper looper, Context context, String logTag, NetworkInfo ni, NetworkCapabilities nc, LinkProperties lp, <span class="keyword">int</span> score, NetworkMisc misc)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// 向ConnectivityService中注册NetworkAgent</span></span><br><span class="line">    <span class="keyword">this</span>.netId = cm.registerNetworkAgent(<span class="keyword">new</span> Messenger(<span class="keyword">this</span>), <span class="keyword">new</span> NetworkInfo(ni), <span class="keyword">new</span> LinkProperties(lp), <span class="keyword">new</span> NetworkCapabilities(nc), score, misc);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerNetworkAgent</span><span class="params">(Messenger messenger, NetworkInfo networkInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            LinkProperties linkProperties, NetworkCapabilities networkCapabilities,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> currentScore, NetworkMisc networkMisc)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  构建NetworkAgentInfo，在NetworkAgentInfo中构建NetworkMonitor</span></span><br><span class="line">    <span class="keyword">final</span> NetworkAgentInfo nai = <span class="keyword">new</span> NetworkAgentInfo(messenger, <span class="keyword">new</span> AsyncChannel(),</span><br><span class="line">          <span class="keyword">new</span> Network(reserveNetId()), <span class="keyword">new</span> NetworkInfo(networkInfo), <span class="keyword">new</span> LinkProperties(</span><br><span class="line">linkProperties), <span class="keyword">new</span> NetworkCapabilities(networkCapabilities), currentScore,mContext, mTrackerHandler, <span class="keyword">new</span> NetworkMisc(networkMisc), mDefaultRequest, <span class="keyword">this</span>);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-网络有效性检测（NetworkMonitor）"><a href="#3-网络有效性检测（NetworkMonitor）" class="headerlink" title="3. 网络有效性检测（NetworkMonitor）"></a>3. 网络有效性检测（NetworkMonitor）</h3><p>NetworkMonitor是一个状态机。负责检测网络有效性，也就是ping网络的过程。ping网络过程中产生的几种状态如下：</p>
<ul>
<li>DefaultState 默认状态 </li>
<li>EvaluatingState 验证状态 </li>
<li>ValidatedState 验证通过状态 </li>
<li>LingeringState 休闲状态，表示网络的验证位是真实的，并且曾经是满足特定NetworkRequest的最高得分网络，但是此时另一个网络满足了NetworkRequest的更高分数，在断开连接前的一段时间前，该网络被“固定”为休闲状态。 </li>
<li>CaptivePortalState 强制门户状态 </li>
<li>MaybeNotifyState 可能通知状态，表示用户可能已被通知需要登录。 在退出该状态时，应该小心清除通知。</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/13838098-54dfaf5e8c873a96.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NetworkMonitor状态机.png"></p>
<p>以正常的ping网站过程为例，DefaultState为默认状态，NetworkMonitor接收到CMD_NETWORK_CONNECTED事件消息后，先由DefaultState状态处理，然后由EvaluatingState处理，最后交给ValidatedState处理。</p>
<p>从NetworkMonitor的初始化，到ping网站的过程，到ping网站的结果影响评分值。这个过程的时序图如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13838098-07f4f715a1ef8978.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NetworkMonitor初始化流程.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handles a network appearing or improving its score.</span></span><br><span class="line"><span class="comment">// - Evaluates all current NetworkRequests that can be</span></span><br><span class="line"><span class="comment">//   satisfied by newNetwork, and reassigns to newNetwork</span></span><br><span class="line"><span class="comment">//   any such requests for which newNetwork is the best.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// - Lingers any validated Networks that as a result are no longer</span></span><br><span class="line"><span class="comment">//   needed. A network is needed if it is the best network for</span></span><br><span class="line"><span class="comment">//   one or more NetworkRequests, or if it is a VPN.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// - Tears down newNetwork if it just became validated</span></span><br><span class="line"><span class="comment">//   but turns out to be unneeded.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// - If reapUnvalidatedNetworks==REAP, tears down unvalidated</span></span><br><span class="line"><span class="comment">//   networks that have no chance (i.e. even if validated)</span></span><br><span class="line"><span class="comment">//   of becoming the highest scoring network.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  1.新的NetworkAgentInfo出来，要重新评估所有的NetworkRequests，如果这个网络是最好的网络，会将这些NetworkRequests reassigns到这个新网络， 比如数据网络连接的情况下，wifi连接成功且网络判通成功，这时候一些网络请求的NetworkRequests 要reassigns 到wifi的NetworkAgentInfo</span></span><br><span class="line"><span class="comment">//  2.Lingers任何一个不再需要的validated Networks，理解 “不再需要”，wifi连接的情况下，data网络正常是会linger的，但是如果此时有一个或多个NetworkRequest的指定的transportType为NetworkCapabilities.TRANSPORT_CELLULAR 此时不会linger这个数据网络，另外这个网络是VPN.也不会被linger</span></span><br><span class="line"><span class="comment">//  3.如果一个不需要的网络，就是被linger的网络，会执行Tears down newNetwork ，导致networkagent调用unwanted()方法 网络interface 都会被关闭（可以通过ifconfig 中消失掉来验证）</span></span><br><span class="line"><span class="comment">//  4.reapUnvalidatedNetworks 最后一个网络会传REAP，导致网络被tear down</span></span><br><span class="line">rematchNetworkAndRequests(NetworkAgentInfo newNetwork,</span><br><span class="line">        ReapUnvalidatedNetworks reapUnvalidatedNetworks, <span class="keyword">long</span> now)</span><br></pre></td></tr></table></figure>
<p>当网络状态变化，网络信息变化都会调用到rematchNetworkAndRequests方法中，最后会根据状态机状态，send不同类型的message，NetworkMonitor收到message之后进行相应的处理。</p>
<p>以收到CMD_NETWORK_CONNECTED为例，当monitor收到CMD_NETWORK_CONNECTED消息的时候，会将状态机切换到EvaluatingState状态，在EvaluatingState的enter()方法中发送CMD_REEVALUATE消息。在processMessage()中处理该消息。最后会调用到isCaptivePortal();中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// isCaptivePortal会根据http或者https请求发起HttpURLConnection()</span></span><br><span class="line">CaptivePortalProbeResult probeResult = isCaptivePortal();</span><br><span class="line"><span class="comment">//根据不同的ping结果，做相应处理</span></span><br><span class="line"><span class="keyword">if</span> (probeResult.isSuccessful()) &#123;</span><br><span class="line">    transitionTo(mValidatedState);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (probeResult.isPortal()) &#123;</span><br><span class="line">    mConnectivityServiceHandler.sendMessage(obtainMessage(EVENT_NETWORK_TESTED,</span><br><span class="line">               NETWORK_TEST_RESULT_INVALID, mNetId, probeResult.redirectUrl));</span><br><span class="line">    mLastPortalProbeResult = probeResult;</span><br><span class="line">    transitionTo(mCaptivePortalState);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Message msg = obtainMessage(CMD_REEVALUATE, ++mReevaluateToken, <span class="number">0</span>);</span><br><span class="line">    sendMessageDelayed(msg, mReevaluateDelayMs);</span><br><span class="line">    logNetworkEvent(NetworkEvent.NETWORK_VALIDATION_FAILED);</span><br><span class="line">    mConnectivityServiceHandler.sendMessage(obtainMessage(</span><br><span class="line">        EVENT_NETWORK_TESTED, NETWORK_TEST_RESULT_INVALID, mNetId,</span><br><span class="line">        probeResult.redirectUrl));</span><br><span class="line">    <span class="keyword">if</span> (mAttempts &gt;= BLAME_FOR_EVALUATION_ATTEMPTS) &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t continue to blame UID forever.</span></span><br><span class="line">        TrafficStats.clearThreadStatsUid();</span><br><span class="line">    &#125;</span><br><span class="line">    mReevaluateDelayMs *= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (mReevaluateDelayMs &gt; MAX_REEVALUATE_DELAY_MS) &#123;</span><br><span class="line">        mReevaluateDelayMs = MAX_REEVALUATE_DELAY_MS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据ping网络的结果来执行不同的操作： </p>
<ul>
<li><strong>ping网络成功</strong>，如果收到的响应码是204，将状态机切换到ValidatedState。当状态机切换到ValidatedState之后，在enter()方法中会发送消息EVENT_NETWORK_TESTED。当ConnectivityService收到EVENT_NETWORK_TESTED之后，调用updateCapabilities()更新网卡能力和重新评估这个网络是否对于所有请求是最优的；如果当前能ping通的网络评分和以前的评分不一致，调用sendUpdatedScoreToFactories()更新评分。</li>
<li><strong>ping网络失败</strong>，网络返回200~399，转到CaptivePortalState状态处理。 </li>
<li><strong>ping网络失败</strong>，不是204，也不是200~399，则发送CMD_REEVALUATE消息，重新触发ping网络的动作。第一次失败，8s后重新ping网络，第二次失败，16s后重新ping网络，时间依次倍增，最长的时间间隔为10分钟。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">maybeHandleNetworkMonitorMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">case</span> NetworkMonitor.EVENT_NETWORK_TESTED: &#123;</span><br><span class="line">        <span class="keyword">final</span> NetworkAgentInfo nai;</span><br><span class="line">        <span class="keyword">synchronized</span> (mNetworkForNetId) &#123;</span><br><span class="line">            nai = mNetworkForNetId.get(msg.arg2);</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">            <span class="keyword">if</span> (valid != nai.lastValidated) &#123;</span><br><span class="line">                <span class="comment">// 更新评分</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> oldScore = nai.getCurrentScore();</span><br><span class="line">                ......</span><br><span class="line">                <span class="comment">// 更新网络接口能力</span></span><br><span class="line">                updateCapabilities(oldScore, nai, nai.networkCapabilities);</span><br><span class="line">                <span class="comment">// 更新评分到网络工厂</span></span><br><span class="line">                <span class="keyword">if</span> (oldScore != nai.getCurrentScore()) sendUpdatedScoreToFactories(nai);</span><br><span class="line">            &#125;</span><br><span class="line">           .....</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ping网络的状态会保存到NetworkAgentInfo中，而后续所有的评分值都会调用NetworkAgentInfo的getCurrentScore()方法来获取，getCurrentScore()方法会根据当前ping网络的状态重新计算评分值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getCurrentScore</span><span class="params">(<span class="keyword">boolean</span> pretendValidated)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果是用户指定的网络，直接给100分</span></span><br><span class="line">	<span class="keyword">if</span> (networkMisc.explicitlySelected &amp;&amp; (networkMisc.acceptUnvalidated || 						pretendValidated)) &#123;</span><br><span class="line">		<span class="keyword">return</span> MAXIMUM_NETWORK_SCORE; <span class="comment">//100</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> score = currentScore;</span><br><span class="line">    <span class="comment">// 如果ping失败了就扣40分，如果ping网络成功，则评分值不变。</span></span><br><span class="line">    <span class="keyword">if</span> (!lastValidated &amp;&amp; !pretendValidated &amp;&amp; !ignoreWifiUnvalidationPenalty()) &#123;</span><br><span class="line">   		score -= UNVALIDATED_SCORE_PENALTY; <span class="comment">// -40</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (score &lt; <span class="number">0</span>) score = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> score;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-网络评分机制"><a href="#3-网络评分机制" class="headerlink" title="3.网络评分机制"></a>3.网络评分机制</h3><p>NetworkFactory的存在意义就是为了帮助ConnectivityService进行评分的管理。一般在NetworkFactory在初始化时，设置固定的评分值，作为评判的标准。<br>NetworkAgent作为一个代理信息的抽象，在其初始化时，也设置了固定的评分值，不过，这个评分值会根据当前的网络情况的不同而变化，其最后的评分值会和NetworkFactory中的固定评分值进行比较，从而筛选出最优网络。</p>
<p>项目中可能涉及的网络源如下：WifiNetworkFactory，TelephonyNetwork，EthernetNetwork，PhoneSwitcher，Tbox。</p>
<p>这些工厂在初始化的时候，会将默认评分注册到ConnectivityService中</p>
<table>
<thead>
<tr>
<th></th>
<th>NetworkFactory初始化</th>
<th>NetworkAgent初始化</th>
<th>NetworkMonitor中ping网络</th>
<th>disconnect</th>
</tr>
</thead>
<tbody><tr>
<td>TelephonyNetwork</td>
<td>50</td>
<td>50</td>
<td>成功：+0 失败：-40 用户指定：+100</td>
<td>0</td>
</tr>
<tr>
<td>Tbox</td>
<td>50</td>
<td>50</td>
<td>成功：+0 失败：-40 用户指定：+100</td>
<td>0</td>
</tr>
<tr>
<td>Wifi</td>
<td>60</td>
<td>60</td>
<td>成功：+0 失败：-40 用户指定：+100</td>
<td>0</td>
</tr>
<tr>
<td>EthernetNetwork</td>
<td>69</td>
<td>69</td>
<td>成功：+0 失败：-40 用户指定：+100</td>
<td>0</td>
</tr>
<tr>
<td>PhoneSwitcher</td>
<td>101</td>
<td>101</td>
<td>成功：+0 失败：-40 用户指定：+100</td>
<td>0</td>
</tr>
</tbody></table>
<p>各种数据业务类型的评分标准，除了其基础评分值不同之外，其他的评判标准都一样。其评分值的变化，主要有以下几种情况：<br>一．代理信息获取结束后，会参与ping网络的过程，如果ping网络成功，那么NetworkAgent中的评分值不变。如果ping网络失败，那么NetworkAgent中的评分值-40。如果用户指定了某种网络类型作为连接方式，那么NetworkAgent重的评分值+100。<br>二．如果NetworkAgent和ConnectivityService的AsyncChannel通道断开，需要设置其评分值为0，好让其他的评分高的网络类型连接。</p>
<p><strong>NetworkFactory中的评分标准：</strong></p>
<p>NetworkFactory中维持了基础的评分分值mScore，mScore只有在 NetworkFactory对象创建的时候才会赋值。因网络环境的变化导致需要重新进行网络评估时，使用基础评分分值与传进来的NetworkRequestInfo中的分值进行比较。</p>
<ul>
<li>如果当前的NetworkRequestInfo没有requested过，且当前的分值score比基础分值mScore小，说明当前的NetworkRequestInfo为最优网络，调用needNetworkFor()连接网络。</li>
<li>如果当前的NetworkRequestInfo已经requested过，且当前的分值score比基础分值mScore大，说明当前的NetworkRequestInfo已经不是最优网络了，有个更优的网络可用连接，此时应该调用releaseNetworkFor()释放掉此类网络连接。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">evalRequest</span><span class="params">(NetworkRequestInfo n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (VDBG) log(<span class="string">&quot;evalRequest request = &quot;</span> + n.request + <span class="string">&quot; with requested = &quot;</span> + n.requested);</span><br><span class="line">    <span class="keyword">if</span> (n.requested == <span class="keyword">false</span> &amp;&amp; n.score &lt; mScore &amp;&amp;</span><br><span class="line">            n.request.networkCapabilities.satisfiedByNetworkCapabilities(</span><br><span class="line">            mCapabilityFilter) &amp;&amp; acceptRequest(n.request, n.score)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (VDBG) log(<span class="string">&quot;  needNetworkFor&quot;</span>);</span><br><span class="line">        needNetworkFor(n.request, n.score);</span><br><span class="line">        n.requested = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n.requested == <span class="keyword">true</span> &amp;&amp;</span><br><span class="line">            (n.score &gt; mScore || n.request.networkCapabilities.satisfiedByNetworkCapabilities(</span><br><span class="line">            mCapabilityFilter) == <span class="keyword">false</span> || acceptRequest(n.request, n.score) == <span class="keyword">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (VDBG) log(<span class="string">&quot;  releaseNetworkFor&quot;</span>);</span><br><span class="line">        releaseNetworkFor(n.request);</span><br><span class="line">        n.requested = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (VDBG) log(<span class="string">&quot;  done&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>触发评分的过程：</strong></p>
<p>1.NetworkFactory与ConnectivityService通过AsyncChannel建立连接的时候，初始化评分，并参与了第一次的评分过程。如果此时还没有ping网络的话，其传进来的评分值为基础评分值，以上代码会执行else逻辑。 </p>
<p>2.调用sendUpdatedScoreToFactories()方法触发了评分过程<br>在ping网络过程中，会触发多次评分过程。在NetworkMonitor的多个状态中，都有向ConnectivityService发起EVENT_NETWORK_TESTED事件消息更新评分</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/10058d760200">Jack Ou</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/10058d760200">https://www.jianshu.com/u/10058d760200</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">此文章版权归Jack Ou所有，如有转载，请註明来自原作者</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86/">网络管理</a><a class="post-meta__tags" href="/tags/ConnectivityService/">ConnectivityService</a></div><div class="post_share"><div class="social-share" data-image="https://upload-images.jianshu.io/upload_images/13838098-fac72f45f8246f49.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://upload-images.jianshu.io/upload_images/13838098-2431fc1f0eb1b702.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank"><img class="post-qr-code-img" src="https://upload-images.jianshu.io/upload_images/13838098-2431fc1f0eb1b702.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://upload-images.jianshu.io/upload_images/13838098-ea2cb9b10bc2f743.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank"><img class="post-qr-code-img" src="https://upload-images.jianshu.io/upload_images/13838098-ea2cb9b10bc2f743.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/27/Android-P%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91-%E7%AC%AC%E4%B8%89%E6%96%B9jar%E5%8C%85%E6%8A%A5DateTimeException/"><img class="prev-cover" src="https://upload-images.jianshu.io/upload_images/13838098-e78841604f22b3e5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android P源码编译, 第三方jar包报DateTimeException</div></div></a></div><div class="next-post pull-right"><a href="/2021/04/06/%E7%BD%91%E7%BB%9C%E8%83%BD%E5%8A%9B%E7%90%86%E8%A7%A3-NetworkCapabilities/"><img class="next-cover" src="https://upload-images.jianshu.io/upload_images/13838098-f3a56e5239c1de70.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">网络能力理解(NetworkCapabilities)</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://upload-images.jianshu.io/upload_images/13838098-a7dfe0e9d3ed649c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Jack Ou</div><div class="author-info__description">All things are difficult before they are easy</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">64</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://www.jianshu.com/u/10058d760200"><i class="fad fa-sheep"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/oujie123" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://www.jianshu.com/u/10058d760200" target="_blank" title="简书"><i class="fas fa-book-open"></i></a><a class="social-icon" href="https://blog.csdn.net/u010248147" target="_blank" title="CSDN"><i class="fab fa-microblog"></i></a><a class="social-icon" href="mailto:815669856@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎收看我的博客，很高兴与您一同成长！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E6%A6%82%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">1.网络管理概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">2.各个服务的初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-ConnectivityService%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.1 ConnectivityService的初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E8%8E%B7%E5%8F%96%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.2.</span> <span class="toc-text">2.1.2 获取其他服务的接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-NetworkFactory%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.3.</span> <span class="toc-text">2.2  NetworkFactory的初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-NetworkAgent%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.4.</span> <span class="toc-text">2.3 NetworkAgent的初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-NetworkMonitor%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.5.</span> <span class="toc-text">2.4 NetworkMonitor的初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BD%91%E7%BB%9C%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E6%B5%8B%EF%BC%88NetworkMonitor%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">3. 网络有效性检测（NetworkMonitor）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BD%91%E7%BB%9C%E8%AF%84%E5%88%86%E6%9C%BA%E5%88%B6"><span class="toc-number">4.</span> <span class="toc-text">3.网络评分机制</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/08/12/%E8%A7%A3%E6%9E%90dumpsys-cpuinfo/" title="解析dumpsys cpuinfo"><img src="https://upload-images.jianshu.io/upload_images/13838098-5d55fd74e9c304b9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="解析dumpsys cpuinfo"/></a><div class="content"><a class="title" href="/2021/08/12/%E8%A7%A3%E6%9E%90dumpsys-cpuinfo/" title="解析dumpsys cpuinfo">解析dumpsys cpuinfo</a><time datetime="2021-08-12T04:09:06.000Z" title="发表于 2021-08-12 12:09:06">2021-08-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/08/04/%E8%B0%83%E6%9F%A5Android-P%E6%8C%81%E7%BB%AD%E6%89%93%E5%8D%B0non-protected-broadcast-%E9%97%AE%E9%A2%98/" title="调查Android P持续打印non-protected broadcast 问题"><img src="https://upload-images.jianshu.io/upload_images/13838098-a01edf9b521303e5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="调查Android P持续打印non-protected broadcast 问题"/></a><div class="content"><a class="title" href="/2021/08/04/%E8%B0%83%E6%9F%A5Android-P%E6%8C%81%E7%BB%AD%E6%89%93%E5%8D%B0non-protected-broadcast-%E9%97%AE%E9%A2%98/" title="调查Android P持续打印non-protected broadcast 问题">调查Android P持续打印non-protected broadcast 问题</a><time datetime="2021-08-04T12:24:46.000Z" title="发表于 2021-08-04 20:24:46">2021-08-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/31/RTMP%E7%9B%B4%E6%92%AD%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%83%A8%E7%BD%B2/" title="RTMP直播客户端部署"><img src="https://upload-images.jianshu.io/upload_images/13838098-428524e1e9693f11.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RTMP直播客户端部署"/></a><div class="content"><a class="title" href="/2021/07/31/RTMP%E7%9B%B4%E6%92%AD%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%83%A8%E7%BD%B2/" title="RTMP直播客户端部署">RTMP直播客户端部署</a><time datetime="2021-07-30T23:43:30.000Z" title="发表于 2021-07-31 07:43:30">2021-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/30/5-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/" title="(5)网络配置管理"><img src="https://upload-images.jianshu.io/upload_images/13838098-ce87e3085f3b0299.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="(5)网络配置管理"/></a><div class="content"><a class="title" href="/2021/07/30/5-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/" title="(5)网络配置管理">(5)网络配置管理</a><time datetime="2021-07-30T02:04:55.000Z" title="发表于 2021-07-30 10:04:55">2021-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/29/%E8%B0%83%E6%9F%A5%E5%BA%94%E7%94%A8%E6%97%A0%E8%BE%9C%E8%A2%ABkill%E9%97%AE%E9%A2%98/" title="调查应用无辜被kill问题"><img src="https://upload-images.jianshu.io/upload_images/13838098-1cd12a1be7c1f1a4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="调查应用无辜被kill问题"/></a><div class="content"><a class="title" href="/2021/07/29/%E8%B0%83%E6%9F%A5%E5%BA%94%E7%94%A8%E6%97%A0%E8%BE%9C%E8%A2%ABkill%E9%97%AE%E9%A2%98/" title="调查应用无辜被kill问题">调查应用无辜被kill问题</a><time datetime="2021-07-29T03:55:55.000Z" title="发表于 2021-07-29 11:55:55">2021-07-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://upload-images.jianshu.io/upload_images/13838098-fac72f45f8246f49.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Jack Ou</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://oujie123.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.spacingElementById('content-inner')
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.spacingElementById('content-inner')
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="true" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script></div></body></html>