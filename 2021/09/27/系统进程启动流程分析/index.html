<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>系统进程启动流程分析 | 美丽的风景往往隐藏在道路的尽头</title><meta name="keywords" content="Android,系统启动,Framework"><meta name="author" content="Jack Ou"><meta name="copyright" content="Jack Ou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="此笔记记录分析Android系统启动过程的分析。">
<meta property="og:type" content="article">
<meta property="og:title" content="系统进程启动流程分析">
<meta property="og:url" content="https://oujie123.github.io/2021/09/27/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="美丽的风景往往隐藏在道路的尽头">
<meta property="og:description" content="此笔记记录分析Android系统启动过程的分析。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13838098-709a95ad43e716d4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2021-09-27T15:35:00.000Z">
<meta property="article:modified_time" content="2021-10-07T17:03:18.462Z">
<meta property="article:author" content="Jack Ou">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Framework">
<meta property="article:tag" content="系统启动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/13838098-709a95ad43e716d4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><link rel="shortcut icon" href="https://upload-images.jianshu.io/upload_images/13838098-8a5cd66eafd7c761.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><link rel="canonical" href="https://oujie123.github.io/2021/09/27/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Jack Ou","link":"链接: ","source":"来源: 美丽的风景往往隐藏在道路的尽头","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-08 01:03:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://upload-images.jianshu.io/upload_images/13838098-a7dfe0e9d3ed649c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">121</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">88</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分栏</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://upload-images.jianshu.io/upload_images/13838098-709a95ad43e716d4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">美丽的风景往往隐藏在道路的尽头</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分栏</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">系统进程启动流程分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-09-27T15:35:00.000Z" title="发表于 2021-09-27 23:35:00">2021-09-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-10-07T17:03:18.462Z" title="更新于 2021-10-08 01:03:18">2021-10-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Framework/">Framework</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h4 id="1-Android系统大致启动流程"><a href="#1-Android系统大致启动流程" class="headerlink" title="1.Android系统大致启动流程"></a>1.Android系统大致启动流程</h4><p>第一步：  启动电源以及系统启动<br>当电源按下，引导芯片代码开始从预定义的地方（固化在ROM）开始执行。加载引导程序到RAM，然后 执行引导程序。</p>
<p>第二步：引导程序<br>引导程序是在Android操作系统开始运行前的一个小程序。引导程序是运行的第一个程序，因此它是针 对特定的主板与芯片的。设备制造商要么使用很受欢迎的引导程序比如redboot、uboot、qi bootloader或者开发自己的引导程序，它不是Android操作系统的一部分。引导程序是OEM厂商或者运 营商加锁和限制的地方。<br>引导程序分两个阶段执行。<br>第一个阶段，检测外部的RAM以及加载对第二阶段有用的程序；<br>第二阶段，引导程序设置网络、内存等等。这些对于运行内核是必要的，为了达到特殊的目标，引导程 序可以根据配置参数或者输入数据设置内核。<br>Android引导程序可以在\bootable\bootloader\legacy\usbloader找到。传统的加载器包含两个文件， 需要在这里说明：<br>init.s初始化堆栈，清零BBS段，调用main.c的_main()函数；<br>main.c初始化硬件（闹钟、主板、键盘、控制台），创建linux标签</p>
<p>第三步：内核<br>Android内核与桌面linux内核启动的方式差不多。内核启动时，设置缓存、被保护存储器、计划列表， 加载驱动。当内核完成系统设置，它首先在系统文件中寻找”init”文件，然后启动root进程或者系统的第 一个进程 </p>
<p>第四步：init进程<br>init进程是Linux系统中用户空间的第一个进程，进程号固定为1。Kernel启动后，在用户空间启动init进 程，并调用init中的main()方法执行init进程的职责。 </p>
<p>第五步：启动zygote进程，通过zygote启动SystemServer，当服务都启动完成之后，启动Lancher App，然后退出开机动画。我们就可以看到桌面应用，此时启动过程就结束了。</p>
<h4 id="2-启动init进程"><a href="#2-启动init进程" class="headerlink" title="2.启动init进程"></a>2.启动init进程</h4><p>init进程是Android系统中及其重要的第一个进程，是由内核拉起来的第一个用户进程。</p>
<p>init进程主要完成了三件事情。</p>
<ul>
<li>创建和挂载启动所需要的文件目录 </li>
<li>初始化和启动属性服务 </li>
<li>解析init.rc配置文件并启动Zygote进程</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \system\core\init\init.cpp main()</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">* 1.C++中主函数有两个参数，第一个参数argc表示参数个数，第二个参数是参数列表，也就是具体 的参数 </span></span><br><span class="line"><span class="comment">* 2.init的main函数有两个其它入口，一是参数中有ueventd，进入ueventd_main,二是参数中 有watchdogd，进入watchdogd_main </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    * 1.strcmp是String的一个函数，比较字符串，相等返回0 </span></span><br><span class="line"><span class="comment">    * 2.C++中0也可以表示false </span></span><br><span class="line"><span class="comment">    * 3.basename是C库中的一个函数，得到特定的路径中的最后一个&#x27;/&#x27;后面的内容， </span></span><br><span class="line"><span class="comment">    * 比如/sdcard/miui_recovery/backup，得到的结果是backup </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">&quot;ueventd&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//当argv[0]的内容为ueventd 时，strcmp的值为0,！strcmp为1 </span></span><br><span class="line">		<span class="comment">//1表示true，也就执行ueventd_main,ueventd主要是负责设备节点的创建、权限设定等一系列工作</span></span><br><span class="line">        <span class="keyword">return</span> ueventd_main(argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">&quot;watchdogd&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//watchdogd俗称看门狗，用于 系统出问题时重启系统</span></span><br><span class="line">        <span class="keyword">return</span> watchdogd_main(argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class="line">        <span class="comment">//初始化重启系统的处理信号，内部通过sigaction 注册信号，当监听到该信号时重启系统</span></span><br><span class="line">        install_reboot_signal_handlers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add_environment(<span class="string">&quot;PATH&quot;</span>, _PATH_DEFPATH);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看是否有环境变量INIT_SECOND_STAGE</span></span><br><span class="line">    <span class="keyword">bool</span> is_first_stage = (getenv(<span class="string">&quot;INIT_SECOND_STAGE&quot;</span>) == <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.init的main方法会执行两次，由is_first_stage控制,first_stage就是第一阶段要做的事</span></span><br><span class="line">    <span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">        boot_clock::time_point start_time = boot_clock::now();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clear the umask.</span></span><br><span class="line">        <span class="comment">//清空文件权限</span></span><br><span class="line">        umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class="line">        <span class="comment">// on / and then we&#x27;ll let the rc file figure out the rest.</span></span><br><span class="line">        <span class="comment">//mount是用来挂载文件系统的，mount属于Linux系统调用</span></span><br><span class="line">        mount(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/dev&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="string">&quot;mode=0755&quot;</span>);</span><br><span class="line">        mkdir(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">0755</span>);;<span class="comment">//创建目录，第一个参数是目录路径，第二个是读写权限</span></span><br><span class="line">        mkdir(<span class="string">&quot;/dev/socket&quot;</span>, <span class="number">0755</span>);</span><br><span class="line">        mount(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class="line">        mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="string">&quot;hidepid=2,gid=&quot;</span> MAKE_STR(AID_READPROC));</span><br><span class="line">        <span class="comment">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class="line">        chmod(<span class="string">&quot;/proc/cmdline&quot;</span>, <span class="number">0440</span>);<span class="comment">//用于修改文件/目录的读写权限</span></span><br><span class="line">        <span class="keyword">gid_t</span> groups[] = &#123; AID_READPROC &#125;;</span><br><span class="line">        <span class="comment">// 用来将list数组中所标明的组加入到目前进程的组设置中</span></span><br><span class="line">        setgroups(arraysize(groups), groups);</span><br><span class="line">        mount(<span class="string">&quot;sysfs&quot;</span>, <span class="string">&quot;/sys&quot;</span>, <span class="string">&quot;sysfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        mount(<span class="string">&quot;selinuxfs&quot;</span>, <span class="string">&quot;/sys/fs/selinux&quot;</span>, <span class="string">&quot;selinuxfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">//mknod用于创建Linux中的设备文件</span></span><br><span class="line">        mknod(<span class="string">&quot;/dev/kmsg&quot;</span>, S_IFCHR | <span class="number">0600</span>, makedev(<span class="number">1</span>, <span class="number">11</span>));</span><br><span class="line">        mknod(<span class="string">&quot;/dev/random&quot;</span>, S_IFCHR | <span class="number">0666</span>, makedev(<span class="number">1</span>, <span class="number">8</span>));</span><br><span class="line">        mknod(<span class="string">&quot;/dev/urandom&quot;</span>, S_IFCHR | <span class="number">0666</span>, makedev(<span class="number">1</span>, <span class="number">9</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class="line">        <span class="comment">// talk to the outside world...</span></span><br><span class="line">        <span class="comment">//将标准输入输出重定向到&quot;/sys/fs/selinux/null&quot;</span></span><br><span class="line">        InitKernelLogging(argv);</span><br><span class="line"></span><br><span class="line">        LOG(INFO) &lt;&lt; <span class="string">&quot;init first stage started!&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!DoFirstStageMount()) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; <span class="string">&quot;Failed to mount required partitions early ...&quot;</span>;</span><br><span class="line">            panic();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Avb即Android Verfied boot,功能包括Secure Boot, verfying boot 和dm-verity, </span></span><br><span class="line">		<span class="comment">//原理都是对二进制文件进行签名，在系统启动时进行认证，确保系统运行的是合法的二进制镜像文件。 </span></span><br><span class="line">		<span class="comment">//其中认证的范围涵盖：bootloader，boot.img，system.img</span></span><br><span class="line">        <span class="comment">// 通过调用FsManagerAvbHandle::Open()-&gt;FsManagerAvbOps::AvbSlotVerify-&gt;avb_slot_verify最终去验证每个分区。</span></span><br><span class="line">        <span class="comment">// 当验证成功之后，会将版本信息写到环境变量 INIT_AVB_VERSION 中</span></span><br><span class="line">        SetInitAvbVersionInRecovery();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up SELinux, loading the SELinux policy.</span></span><br><span class="line">        <span class="comment">//加载SELinux policy，也就是安全策略，</span></span><br><span class="line">        selinux_initialize(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;re in the kernel domain, so re-exec init to transition to the init domain now</span></span><br><span class="line">        <span class="comment">// that the SELinux policy has been loaded.</span></span><br><span class="line">        <span class="comment">// 我们执行第一遍init的main方法是在kernel domain，所以要重新执行init文件，切换到加载了selinux策略的init domain，</span></span><br><span class="line">        <span class="keyword">if</span> (restorecon(<span class="string">&quot;/init&quot;</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            PLOG(ERROR) &lt;&lt; <span class="string">&quot;restorecon failed&quot;</span>;</span><br><span class="line">            security_failure();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置进入第二阶段标志位，进入第二阶段</span></span><br><span class="line">        setenv(<span class="string">&quot;INIT_SECOND_STAGE&quot;</span>, <span class="string">&quot;true&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">uint32_t</span> kNanosecondsPerMillisecond = <span class="number">1e6</span>;</span><br><span class="line">        <span class="keyword">uint64_t</span> start_ms = start_time.time_since_epoch().count() / kNanosecondsPerMillisecond;</span><br><span class="line">        setenv(<span class="string">&quot;INIT_STARTED_AT&quot;</span>, StringPrintf(<span class="string">&quot;%&quot;</span> PRIu64, start_ms).c_str(), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>* path = argv[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">char</span>* args[] = &#123; path, <span class="literal">nullptr</span> &#125;;</span><br><span class="line">        <span class="comment">// 重新执行init,由于标志位置为了，因此再次执行init会进入阶段。</span></span><br><span class="line">        execv(path, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// execv() only returns if an error happened, in which case we</span></span><br><span class="line">        <span class="comment">// panic and never fall through this conditional.</span></span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">&quot;execv(\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;) failed&quot;</span>;</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// At this point we&#x27;re in the second stage of init.</span></span><br><span class="line">    InitKernelLogging(argv);</span><br><span class="line">    LOG(INFO) &lt;&lt; <span class="string">&quot;init second stage started!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up a session keyring that all processes will have access to. It</span></span><br><span class="line">    <span class="comment">// will hold things like FBE encryption keys. No process should override</span></span><br><span class="line">    <span class="comment">// its session keyring.</span></span><br><span class="line">    keyctl(KEYCTL_GET_KEYRING_ID, KEY_SPEC_SESSION_KEYRING, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indicate that booting is in progress to background fw loaders, etc.</span></span><br><span class="line">    close(open(<span class="string">&quot;/dev/.booting&quot;</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="number">0000</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化属性系统，并从指定文件读取属性</span></span><br><span class="line">    <span class="comment">// bionic/libc/bionic/system_properties.c</span></span><br><span class="line">    <span class="comment">// __system_property_area_init-&gt;map_prop_area_rw-&gt;打开/dev/__properties__文件-&gt;并且映射128kb空间大小内存来存属性键值对。</span></span><br><span class="line">    property_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If arguments are passed both on the command line and in DT,</span></span><br><span class="line">    <span class="comment">// properties set in DT always have priority over the command-line ones.</span></span><br><span class="line">    <span class="comment">//接下来的一系列操作都是从各个文件读取一些属性，然后通过property_set设置系统属性</span></span><br><span class="line">    <span class="comment">// 1.这句英文的大概意思是，如果参数同时从命令行和DT传过来，DT的优先级总是大于命令行的。</span></span><br><span class="line">    <span class="comment">// 2.DT即device-tree，中文意思是设备树，这里面记录自己的硬件配置和系统运行参数，参考http://www.wowotech.net/linux_kenrel/why-dt.html</span></span><br><span class="line">    process_kernel_dt();<span class="comment">//处理DT属性</span></span><br><span class="line">    process_kernel_cmdline();<span class="comment">//处理命令行属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Propagate the kernel variables to internal variables</span></span><br><span class="line">    <span class="comment">// used by init as well as the current required properties.</span></span><br><span class="line">    export_kernel_boot_props();<span class="comment">//处理其他的一些属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make the time that init started available for bootstat to log.</span></span><br><span class="line">    property_set(<span class="string">&quot;ro.boottime.init&quot;</span>, getenv(<span class="string">&quot;INIT_STARTED_AT&quot;</span>));</span><br><span class="line">    property_set(<span class="string">&quot;ro.boottime.init.selinux&quot;</span>, getenv(<span class="string">&quot;INIT_SELINUX_TOOK&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set libavb version for Framework-only OTA match in Treble build.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* avb_version = getenv(<span class="string">&quot;INIT_AVB_VERSION&quot;</span>);</span><br><span class="line">    <span class="comment">// 将avb版本设置到系统属性中</span></span><br><span class="line">    <span class="keyword">if</span> (avb_version) property_set(<span class="string">&quot;ro.boot.avb_version&quot;</span>, avb_version);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up our environment.</span></span><br><span class="line">    <span class="comment">// 清除环境变量</span></span><br><span class="line">    unsetenv(<span class="string">&quot;INIT_SECOND_STAGE&quot;</span>);</span><br><span class="line">    unsetenv(<span class="string">&quot;INIT_STARTED_AT&quot;</span>);</span><br><span class="line">    unsetenv(<span class="string">&quot;INIT_SELINUX_TOOK&quot;</span>);</span><br><span class="line">    unsetenv(<span class="string">&quot;INIT_AVB_VERSION&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now set up SELinux for second stage.</span></span><br><span class="line">    selinux_initialize(<span class="literal">false</span>);</span><br><span class="line">    selinux_restore_context();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建epoll实例，并返回epoll的文件描述符</span></span><br><span class="line">    epoll_fd = epoll_create1(EPOLL_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (epoll_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">&quot;epoll_create1 failed&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主要是创建handler处理子进程终止信号，创建一个匿名 socket并注册到epoll进行监听</span></span><br><span class="line">    signal_handler_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文件中加载一些属性，读取usb配置</span></span><br><span class="line">    <span class="comment">// 涉及到的文件，/system/etc/prop.default，/odm/default.prop，/vendor/default.prop</span></span><br><span class="line">    property_load_boot_defaults();</span><br><span class="line">    export_oem_lock_status();<span class="comment">// 设置ro.boot.flash.locked 属性</span></span><br><span class="line">    start_property_service();<span class="comment">//开启一个socket监听系统属性的设置</span></span><br><span class="line">    set_usb_controller();<span class="comment">//设置sys.usb.controller 属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//init.rc文件中方法映射,例如“class_start”-&gt; &quot;do_class_start&quot;</span></span><br><span class="line">    <span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line">    Action::set_function_map(&amp;function_map);<span class="comment">//将function_map存放到Action中作 为成员属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用不同的parse解析init.rc文件中的不同字段，并且将service保存在servicelist中</span></span><br><span class="line">    Parser&amp; parser = Parser::GetInstance();</span><br><span class="line">    parser.AddSectionParser(<span class="string">&quot;service&quot;</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</span><br><span class="line">    parser.AddSectionParser(<span class="string">&quot;on&quot;</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</span><br><span class="line">    parser.AddSectionParser(<span class="string">&quot;import&quot;</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> bootscript = GetProperty(<span class="string">&quot;ro.boot.init_rc&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (bootscript.empty()) &#123;</span><br><span class="line">        <span class="comment">// 以下目录的所有rc文件默认都会被解析</span></span><br><span class="line">        parser.ParseConfig(<span class="string">&quot;/init.rc&quot;</span>);</span><br><span class="line">        parser.set_is_system_etc_init_loaded(</span><br><span class="line">                parser.ParseConfig(<span class="string">&quot;/system/etc/init&quot;</span>));</span><br><span class="line">        parser.set_is_vendor_etc_init_loaded(</span><br><span class="line">                parser.ParseConfig(<span class="string">&quot;/vendor/etc/init&quot;</span>));</span><br><span class="line">        parser.set_is_odm_etc_init_loaded(parser.ParseConfig(<span class="string">&quot;/odm/etc/init&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parser.ParseConfig(bootscript);</span><br><span class="line">        parser.set_is_system_etc_init_loaded(<span class="literal">true</span>);</span><br><span class="line">        parser.set_is_vendor_etc_init_loaded(<span class="literal">true</span>);</span><br><span class="line">        parser.set_is_odm_etc_init_loaded(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span></span><br><span class="line">    <span class="comment">// Nexus 9 boot time, so it&#x27;s disabled by default.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>) parser.DumpState();<span class="comment">//打印一些当前Parser的信息，默认是不执行的</span></span><br><span class="line"></span><br><span class="line">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// QueueEventTrigger用于触发Action,这里触发early-init事件</span></span><br><span class="line">    am.QueueEventTrigger(<span class="string">&quot;early-init&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class="line">    <span class="comment">//QueueBuiltinAction用于添加Action，第一个参数是 Action要执行的Command,第二个是Trigger</span></span><br><span class="line">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class="string">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class="line">    <span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class="line">    am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, <span class="string">&quot;mix_hwrng_into_linux_rng&quot;</span>);</span><br><span class="line">    am.QueueBuiltinAction(set_mmap_rnd_bits_action, <span class="string">&quot;set_mmap_rnd_bits&quot;</span>);</span><br><span class="line">    am.QueueBuiltinAction(set_kptr_restrict_action, <span class="string">&quot;set_kptr_restrict&quot;</span>);</span><br><span class="line">    am.QueueBuiltinAction(keychord_init_action, <span class="string">&quot;keychord_init&quot;</span>);</span><br><span class="line">    am.QueueBuiltinAction(console_init_action, <span class="string">&quot;console_init&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger all the boot actions to get us started.</span></span><br><span class="line">    am.QueueEventTrigger(<span class="string">&quot;init&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class="line">    <span class="comment">// wasn&#x27;t ready immediately after wait_for_coldboot_done</span></span><br><span class="line">    am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, <span class="string">&quot;mix_hwrng_into_linux_rng&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t mount filesystems or start core system services in charger mode.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> bootmode = GetProperty(<span class="string">&quot;ro.bootmode&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (bootmode == <span class="string">&quot;charger&quot;</span>) &#123;</span><br><span class="line">        am.QueueEventTrigger(<span class="string">&quot;charger&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        am.QueueEventTrigger(<span class="string">&quot;late-init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run all property triggers based on current state of the properties.</span></span><br><span class="line">    am.QueueBuiltinAction(queue_property_triggers_action, <span class="string">&quot;queue_property_triggers&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// By default, sleep until something happens.</span></span><br><span class="line">        <span class="keyword">int</span> epoll_timeout_ms = <span class="number">-1</span>; <span class="comment">//epoll超时时间，相当于阻塞时间</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(waiting_for_prop || ServiceManager::GetInstance().IsWaitingForExec())) &#123;</span><br><span class="line">            am.ExecuteOneCommand();<span class="comment">//执行一个command</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(waiting_for_prop || ServiceManager::GetInstance().IsWaitingForExec())) &#123;</span><br><span class="line">            restart_processes();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If there&#x27;s a process that needs restarting, wake up in time for that.</span></span><br><span class="line">            <span class="keyword">if</span> (process_needs_restart_at != <span class="number">0</span>) &#123;</span><br><span class="line">                epoll_timeout_ms = (process_needs_restart_at - time(<span class="literal">nullptr</span>)) * <span class="number">1000</span>;</span><br><span class="line">                <span class="keyword">if</span> (epoll_timeout_ms &lt; <span class="number">0</span>) epoll_timeout_ms = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If there&#x27;s more work to do, wake up again immediately.</span></span><br><span class="line">            <span class="comment">//当还有命令要执行时，将epoll_timeout_ms设置为0</span></span><br><span class="line">            <span class="keyword">if</span> (am.HasMoreCommands()) epoll_timeout_ms = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        epoll_event ev;</span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">        * 1.epoll_wait与epoll_create1、epoll_ctl是一起使用的 </span></span><br><span class="line"><span class="comment">        * 2.epoll_create1用于创建epoll的文件描述符，epoll_ctl、epoll_wait都把它创建的fd作为第一个参数传入 </span></span><br><span class="line"><span class="comment">        * 3.epoll_ctl用于操作epoll，EPOLL_CTL_ADD：注册新的fd到epfd中， </span></span><br><span class="line"><span class="comment">        EPOLL_CTL_MOD：修改已经注册的fd的监听事件，EPOLL_CTL_DEL：从epfd中删除一个fd； </span></span><br><span class="line"><span class="comment">        * 4.epoll_wait用于等待事件的产生，epoll_ctl调用EPOLL_CTL_ADD时会传入需要监听什么类型的事件， </span></span><br><span class="line"><span class="comment">        *比如EPOLLIN表示监听fd可读，当该fd有可读的数据时，调用epoll_wait经过epoll_timeout_ms时间就会把该事件的信息返回给&amp;ev </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">int</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, <span class="number">1</span>, epoll_timeout_ms));</span><br><span class="line">        <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</span><br><span class="line">            PLOG(ERROR) &lt;&lt; <span class="string">&quot;epoll_wait failed&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//当有event返回时，取出 ev.data.ptr（之前epoll_ctl注册时的回调函数），直接执行 </span></span><br><span class="line">            <span class="comment">//在signal_handler_init和start_property_service有注册两个fd的监听，一个用于监听SIGCHLD(子进程结束信号)，一个用于监听属性设置</span></span><br><span class="line">            ((<span class="keyword">void</span> (*)()) ev.data.ptr)();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="3-解析init-rc"><a href="#3-解析init-rc" class="headerlink" title="3.解析init.rc"></a>3.解析init.rc</h4><p>init.rc是一个非常重要的配置文件，它是由Android初始化语言（Android Init Language）编写的脚本，它主要包含五种类型语句：Action（Action中包含了一系列的Command）、Commands（init语言中的命令）、Services（由init进程启动的服务）、Options（对服务进行配置的选项）和Import（引入其他配置文件）。init.rc的配置代码如下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> \system\core\rootdir\init.rc</span> </span><br><span class="line">on init # L41</span><br><span class="line">	sysclktz 0</span><br><span class="line"><span class="meta">   #</span><span class="bash"> Mix device-specific information into the entropy pool</span>    </span><br><span class="line">   copy /proc/cmdline /dev/urandom</span><br><span class="line">   copy /default.prop /dev/urandom</span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]* //设置触发器     </span><br><span class="line">	&lt;command&gt;</span><br><span class="line">    &lt;command&gt; //动作触发之后要执行的命令</span><br><span class="line">    </span><br><span class="line">service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]* #&lt;service的名字&gt;&lt;执行程序路径&gt;&lt;传递参数&gt;</span><br><span class="line">    &lt;option&gt;  #Options是Services的参数配置. 它们影响Service如何运行及运行时机     </span><br><span class="line">    group &lt;groupname&gt; [ &lt;groupname&gt;\* ] #在启动Service前将group改为第一个 groupname,第一个groupname是必须有的，默认值为root（或许默认值是无），第二个groupname可以不设置，用于追加组（通过 setgroups）</span><br><span class="line">    priority &lt;priority&gt; #设置进程优先级. 在-20～19之间，默认值是0,能过 setpriority实现</span><br><span class="line">    socket &lt;name&gt; &lt;type&gt; &lt;perm&gt; [ &lt;user&gt; [ &lt;group&gt; [ &lt;seclabel&gt; ] ] ] #创建 一个unix域的socket,名字叫/dev/socket/name , 并将fd返回给Service. type 只能是 &quot;dgram&quot;, &quot;stream&quot; or &quot;seqpacket&quot;.</span><br></pre></td></tr></table></figure>


<h5 id="3-1-Action"><a href="#3-1-Action" class="headerlink" title="3.1 Action"></a>3.1 Action</h5><p>Action：  通过触发器trigger，即以on开头的语句来决定执行相应的service的时机，具体有如下时机：</p>
<ul>
<li>on early-init; 在初始化早期阶段触发； </li>
<li>on init; 在初始化阶段触发；</li>
<li>on late-init; 在初始化晚期阶段触发；</li>
<li>on boot/charger：  当系统启动/充电时触发，还包含其他情况，此处不一一列举； </li>
<li>on property:=: 当属性值满足条件时触发</li>
</ul>
<h5 id="3-2-Service"><a href="#3-2-Service" class="headerlink" title="3.2 Service"></a>3.2 Service</h5><p>服务Service，以 service开头，由init进程启动，一般运行在init的一个子进程，所以启动service前需要判断对应的可执行文件是否存在。init生成的子进程，定义在rc文件，其中每一个service在启动时会通过 fork方式生成子进程。<br>例如：   service servicemanager /system/bin/servicemanager代表的是服务名为 servicemanager，服务执行的路径为/system/bin/servicemanager。</p>
<h5 id="3-3-Command"><a href="#3-3-Command" class="headerlink" title="3.3 Command"></a>3.3 Command</h5><p>下面列举常用的命令:</p>
<ul>
<li>class_start <service_class_name>：  启动属于同一个class的所有服务；</service_class_name></li>
<li> start <service_name>：  启动指定的服务，若已启动则跳过；</service_name></li>
<li>stop <service_name>：  停止正在运行的服务 </service_name></li>
<li>setprop  ：设置属性值</li>
<li>mkdir ：创建指定目录</li>
<li>symlink  <sym_link>：  创建连接到的<sym_link>符号链接；</sym_link></sym_link></li>
<li>write  ：  向文件path中写入字符串；</li>
<li>exec： fork并执行，会阻塞init进程直到程序完毕；</li>
<li>exprot：设定环境变量；</li>
<li>loglevel ：设置log级别</li>
</ul>
<h5 id="3-4-Options"><a href="#3-4-Options" class="headerlink" title="3.4 Options"></a>3.4 Options</h5><p>Options是Service的可选项，与service配合使用</p>
<ul>
<li>disabled: 不随class自动启动，只有根据service名才启动； </li>
<li>oneshot: service退出后不再重启；</li>
<li>user/group：  设置执行服务的用户/用户组，默认都是root；</li>
<li>class：设置所属的类名，当所属类启动/退出时，服务也启动/停止，默认为default； onrestart:当服务重启时执行相应命令；</li>
<li>socket: 创建名为 /dev/socket/<name>的socket</name></li>
<li>critical: 在规定时间内该service不断重启，则系统会重启并进入恢复模式 </li>
<li><strong>default</strong>: 意味着disabled=false，oneshot=false，critical=false。</li>
</ul>
<p>下面看看zygote的rc脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote -- start-system-server</span><br><span class="line">   class main    </span><br><span class="line">   priority -20    </span><br><span class="line">   user root</span><br><span class="line">   group root readproc reserved_disk    </span><br><span class="line">   socket zygote stream 660 root system</span><br><span class="line">   onrestart write /sys/android_power/request_state wake</span><br><span class="line">   onrestart write /sys/power/state on</span><br><span class="line">   onrestart restart audioserver</span><br><span class="line">   onrestart restart cameraserver</span><br><span class="line">   onrestart restart media</span><br><span class="line">   onrestart restart netd</span><br><span class="line">   onrestart restart wificond</span><br><span class="line">   writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure>


<h5 id="3-5-逐行解析脚本"><a href="#3-5-逐行解析脚本" class="headerlink" title="3.5 逐行解析脚本"></a>3.5 逐行解析脚本</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system\core\init\init_parser.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Parser::ParseData</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Use a parser with const input and remove this copy</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt; <span class="title">data_copy</span><span class="params">(data.begin(), data.end())</span></span>;</span><br><span class="line">    data_copy.push_back(<span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    parse_state state;</span><br><span class="line">    state.filename = filename.c_str();</span><br><span class="line">    state.line = <span class="number">0</span>;</span><br><span class="line">    state.ptr = &amp;data_copy[<span class="number">0</span>];</span><br><span class="line">    state.nexttoken = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    SectionParser* section_parser = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (next_token(&amp;state)) &#123;</span><br><span class="line">        <span class="keyword">case</span> T_EOF:</span><br><span class="line">            <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">                <span class="comment">// 结束解析</span></span><br><span class="line">                section_parser-&gt;EndSection();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">case</span> T_NEWLINE:</span><br><span class="line">            state.line++;</span><br><span class="line">            <span class="keyword">if</span> (args.empty()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (section_parsers_.count(args[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">                    section_parser-&gt;EndSection();</span><br><span class="line">                &#125;</span><br><span class="line">                section_parser = section_parsers_[args[<span class="number">0</span>]].get();</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</span><br><span class="line">                <span class="comment">// 逐行解析</span></span><br><span class="line">                <span class="keyword">if</span> (!section_parser-&gt;ParseSection(args, &amp;ret_err)) &#123;</span><br><span class="line">                    parse_error(&amp;state, <span class="string">&quot;%s\n&quot;</span>, ret_err.c_str());</span><br><span class="line">                    section_parser = <span class="literal">nullptr</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</span><br><span class="line">                <span class="keyword">if</span> (!section_parser-&gt;ParseLineSection(args, state.filename,</span><br><span class="line">                                                      state.line, &amp;ret_err)) &#123;</span><br><span class="line">                    parse_error(&amp;state, <span class="string">&quot;%s\n&quot;</span>, ret_err.c_str());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            args.clear();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> T_TEXT:</span><br><span class="line">            args.emplace_back(state.text);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \system\core\init\service.cpp </span></span><br><span class="line"><span class="function">Result&lt;Success&gt; <span class="title">ServiceParser::ParseSection</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp;&amp; args,                                            <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (args.size() &lt; <span class="number">3</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> Error() &lt;&lt; <span class="string">&quot;services must have a name and a program&quot;</span>;  &#125;</span><br><span class="line">   <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name = args[<span class="number">1</span>];    <span class="keyword">if</span> (!IsValidName(name)) &#123;</span><br><span class="line">       <span class="keyword">return</span> Error() &lt;&lt; <span class="string">&quot;invalid service name &#x27;&quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot;&#x27;&quot;</span>;  &#125;</span><br><span class="line">   Subcontext* restart_action_subcontext = <span class="literal">nullptr</span>;    <span class="keyword">if</span> (subcontexts_) &#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; subcontext : *subcontexts_) &#123;</span><br><span class="line">           <span class="keyword">if</span> (StartsWith(filename, subcontext.path_prefix())) &#123;                restart_action_subcontext = &amp;subcontext;</span><br><span class="line">               <span class="keyword">break</span>;        &#125;</span><br><span class="line">     &#125;  &#125;</span><br><span class="line">   <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; <span class="title">str_args</span><span class="params">(args.begin() + <span class="number">2</span>, args.end())</span></span>;</span><br><span class="line">   service_ = <span class="built_in">std</span>::make_unique&lt;Service&gt;(name, restart_action_subcontext, str_args);<span class="comment">//构建出一个service对象</span></span><br><span class="line">   <span class="keyword">return</span> Success(); &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \system\core\init\service.cpp </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ServiceParser::EndSection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (service_) &#123;</span><br><span class="line">        <span class="comment">// 如果上面解析的service不为空，就加入到ServiceManager中</span></span><br><span class="line">        ServiceManager::GetInstance().AddService(<span class="built_in">std</span>::move(service_));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面解析完成后，接下来就是启动Service,这里我们以启动Zygote来分析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> \system\core\rootdir\init.rc L680</span> </span><br><span class="line">on nonencrypted</span><br><span class="line">   class_start main #class_start是一个命令，通过do_class_start函数处理    </span><br><span class="line">   class_start 	late_start</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># system\core\init\builtins.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Result&lt;Success&gt; <span class="title">do_class_start</span><span class="params">(<span class="keyword">const</span> BuiltinArguments&amp; args)</span> </span>&#123;    </span><br><span class="line">   <span class="comment">// Starting a class does not start services which are explicitly disabled.</span></span><br><span class="line">   <span class="comment">// They must  be started individually.</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; service : ServiceList::GetInstance()) &#123;        </span><br><span class="line">       <span class="keyword">if</span> (service-&gt;classnames().count(args[<span class="number">1</span>])) &#123;</span><br><span class="line">           <span class="comment">// 调用刚刚注册的service的StartIfNotDisabled()方法</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">auto</span> result = service-&gt;StartIfNotDisabled(); !result) &#123;</span><br><span class="line">               LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not start service &#x27;&quot;</span> &lt;&lt; service-&gt;name()                           &lt;&lt; <span class="string">&quot;&#x27; as part of class &#x27;&quot;</span> &lt;&lt; args[<span class="number">1</span>] &lt;&lt; <span class="string">&quot;&#x27;: &quot;</span> &lt;&lt; result.error();</span><br><span class="line">      	 &#125;      </span><br><span class="line">       &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">   <span class="keyword">return</span> Success(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \system\core\init\service.cpp </span></span><br><span class="line"><span class="function">Result&lt;Success&gt; <span class="title">Service::StartIfNotDisabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!(flags_ &amp; SVC_DISABLED)) &#123;        </span><br><span class="line">       <span class="keyword">return</span> Start();</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       flags_ |= SVC_DISABLED_START;  &#125;</span><br><span class="line">   	   <span class="keyword">return</span> Success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Service::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Starting a service removes it from the disabled or reset state and</span></span><br><span class="line">    <span class="comment">// immediately takes it out of the restarting state if it was in there.</span></span><br><span class="line">    flags_ &amp;= (~(SVC_DISABLED|SVC_RESTARTING|SVC_RESET|SVC_RESTART|SVC_DISABLED_START));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果service已经启动了，就不启动了</span></span><br><span class="line">    <span class="keyword">if</span> (flags_ &amp; SVC_RUNNING) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line">    <span class="comment">//判断需要启动的service的对应的执行文件是否存在，不存在则不启动service</span></span><br><span class="line">    <span class="keyword">if</span> (stat(args_[<span class="number">0</span>].c_str(), &amp;sb) == <span class="number">-1</span>) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">&quot;cannot find &#x27;&quot;</span> &lt;&lt; args_[<span class="number">0</span>] &lt;&lt; <span class="string">&quot;&#x27;, disabling &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        flags_ |= SVC_DISABLED;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> scon;</span><br><span class="line">    <span class="keyword">if</span> (!seclabel_.empty()) &#123;</span><br><span class="line">        scon = seclabel_;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG(INFO) &lt;&lt; <span class="string">&quot;computing context for service &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        scon = ComputeContextFromExecutable(name_, args_[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (scon == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG(INFO) &lt;&lt; <span class="string">&quot;starting service &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class="string">&quot;&#x27;...&quot;</span>;</span><br><span class="line">	<span class="comment">//如果子进程没有启动，则调用fork函数创建子进程</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (namespace_flags_) &#123;</span><br><span class="line">        pid = clone(<span class="literal">nullptr</span>, <span class="literal">nullptr</span>, namespace_flags_ | SIGCHLD, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pid = fork();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;<span class="comment">//当期代码逻辑在子进程中运行</span></span><br><span class="line">        umask(<span class="number">077</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (namespace_flags_ &amp; CLONE_NEWPID) &#123;</span><br><span class="line">            <span class="comment">// This will fork again to run an init process inside the PID</span></span><br><span class="line">            <span class="comment">// namespace.</span></span><br><span class="line">            SetUpPidNamespace(name_);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; ei : envvars_) &#123;</span><br><span class="line">            add_environment(ei.name.c_str(), ei.value.c_str());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::for_each(descriptors_.begin(), descriptors_.end(),</span><br><span class="line">                      <span class="built_in">std</span>::bind(&amp;DescriptorInfo::CreateAndPublish, <span class="built_in">std</span>::placeholders::_1, scon));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See if there were &quot;writepid&quot; instructions to write to files under /dev/cpuset/.</span></span><br><span class="line">        <span class="keyword">auto</span> cpuset_predicate = [](<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</span><br><span class="line">            <span class="keyword">return</span> android::base::StartsWith(path, <span class="string">&quot;/dev/cpuset/&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">auto</span> iter = <span class="built_in">std</span>::find_if(writepid_files_.begin(), writepid_files_.end(), cpuset_predicate);</span><br><span class="line">        <span class="keyword">if</span> (iter == writepid_files_.end()) &#123;</span><br><span class="line">            <span class="comment">// There were no &quot;writepid&quot; instructions for cpusets, check if the system default</span></span><br><span class="line">            <span class="comment">// cpuset is specified to be used for the process.</span></span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> default_cpuset = android::base::GetProperty(<span class="string">&quot;ro.cpuset.default&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!default_cpuset.empty()) &#123;</span><br><span class="line">                <span class="comment">// Make sure the cpuset name starts and ends with &#x27;/&#x27;.</span></span><br><span class="line">                <span class="comment">// A single &#x27;/&#x27; means the &#x27;root&#x27; cpuset.</span></span><br><span class="line">                <span class="keyword">if</span> (default_cpuset.front() != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                    default_cpuset.insert(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (default_cpuset.back() != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                    default_cpuset.push_back(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                writepid_files_.push_back(</span><br><span class="line">                    StringPrintf(<span class="string">&quot;/dev/cpuset%stasks&quot;</span>, default_cpuset.c_str()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> pid_str = StringPrintf(<span class="string">&quot;%d&quot;</span>, getpid());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; file : writepid_files_) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!WriteStringToFile(pid_str, file)) &#123;</span><br><span class="line">                PLOG(ERROR) &lt;&lt; <span class="string">&quot;couldn&#x27;t write &quot;</span> &lt;&lt; pid_str &lt;&lt; <span class="string">&quot; to &quot;</span> &lt;&lt; file;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ioprio_class_ != IoSchedClass_NONE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (android_set_ioprio(getpid(), ioprio_class_, ioprio_pri_)) &#123;</span><br><span class="line">                PLOG(ERROR) &lt;&lt; <span class="string">&quot;failed to set pid &quot;</span> &lt;&lt; getpid()</span><br><span class="line">                            &lt;&lt; <span class="string">&quot; ioprio=&quot;</span> &lt;&lt; ioprio_class_ &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; ioprio_pri_;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (needs_console) &#123;</span><br><span class="line">            setsid();</span><br><span class="line">            OpenConsole();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ZapStdio();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// As requested, set our gid, supplemental gids, uid, context, and</span></span><br><span class="line">        <span class="comment">// priority. Aborts on failure.</span></span><br><span class="line">        SetProcessAttributes();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>*&gt; strs;</span><br><span class="line">        <span class="comment">//调用execv函数，启动sevice子进程</span></span><br><span class="line">        ExpandArgs(args_, &amp;strs);</span><br><span class="line">        <span class="keyword">if</span> (execve(strs[<span class="number">0</span>], (<span class="keyword">char</span>**) &amp;strs[<span class="number">0</span>], (<span class="keyword">char</span>**) ENV) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            PLOG(ERROR) &lt;&lt; <span class="string">&quot;cannot execve(&#x27;&quot;</span> &lt;&lt; strs[<span class="number">0</span>] &lt;&lt; <span class="string">&quot;&#x27;)&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _exit(<span class="number">127</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h4 id="4-zygote启动"><a href="#4-zygote启动" class="headerlink" title="4.zygote启动"></a>4.zygote启动</h4><p>上面看到了解析了init.rc之后就可以启动服务。下面我们来看看zygote是如何启动的，启动起来干了什么事情。</p>
<h5 id="4-1-Zygote简述"><a href="#4-1-Zygote简述" class="headerlink" title="4.1 Zygote简述"></a>4.1 Zygote简述</h5><p>Zygote是一个C/S模型，Zygote进程作为服务端，它主要负责创建Java虚拟机，加载系统资源，启动SystemServer进程，以及在后续运行过程中启动普通的应用程序，其他进程作为客户端向它发 出“孵化”请求，而Zygote接收到这个请求后就“孵化”出一个新的进程。比如，当点击Launcher里的 应用程序图标去启动一个新的应用程序进程时，这个请求会到达框架层的核心服务 ActivityManagerService中，当AMS收到这个请求后，它通过调用Process类发出一个“孵化”子进 程的Socket请求，而Zygote监听到这个请求后就立刻fork一个新的进程出来。</p>
<p>zygote的启动脚本文件是：init.zygoteXX.rc，在init.rc中会引用该rc文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import /init.$&#123;ro.zygote&#125;.rc</span><br></pre></td></tr></table></figure>
<p>${ro.zygote} 会被替换成 ro.zyogte 的属性值，这个是由不同的硬件厂商自己定制的， 有四个值，</p>
<ul>
<li>zygote32： zygote 进程对应的执行程序是 app_process (纯 32bit 模式)</li>
<li>zygote64： zygote 进程对应的执行程序是 app_process64 (纯 64bit 模式)</li>
<li>zygote32_64：  启动两个 zygote 进程 (名为 zygote 和 zygote_secondary)，对应的执行程序分别 是 app_process32 (主模式)</li>
<li>zygote64_32：    启动两个 zygote 进程 (名为 zygote 和 zygote_secondary)，对应的执行程序分别 是 app_process64 (主模式)、app_process32</li>
</ul>
<h5 id="4-2-正式启动zygote"><a href="#4-2-正式启动zygote" class="headerlink" title="4.2 正式启动zygote"></a>4.2 正式启动zygote</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 位置：system\core\rootdir\init.rc  L560</span></span><br><span class="line">start zygote</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> It is recommended to put unnecessary data/ initialization from post-fs- data</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to start-zygote <span class="keyword">in</span> device<span class="string">&#x27;s init.rc to unblock zygote start. on zygote-start &amp;&amp; property:ro.crypto.state=unencrypted</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash"> A/B update verifier that marks a successful boot.    exec_start update_verifier_nonencrypted</span></span><br><span class="line">   start netd</span><br><span class="line">   start zygote</span><br><span class="line">   start zygote_secondary</span><br><span class="line">on zygote-start &amp;&amp; property:ro.crypto.state=unsupported   # A/B update verifier that marks a successful boot.   exec_start update_verifier_nonencrypted</span><br><span class="line">   start netd</span><br><span class="line">   start zygote</span><br><span class="line">   start zygote_secondary</span><br><span class="line">on zygote-start &amp;&amp; property:ro.crypto.state=encrypted &amp;&amp; property:ro.crypto.type=file</span><br><span class="line"><span class="meta">   #</span><span class="bash"> A/B update verifier that marks a successful boot.    exec_start update_verifier_nonencrypted</span></span><br><span class="line">   start netd</span><br><span class="line">   start zygote</span><br><span class="line">   start zygote_secondary</span><br></pre></td></tr></table></figure>
<p>无论是否启动FDE/FBE加密，都依赖zygote-start，zygote-start 是在 on late-init 中触发的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Mount filesystems and start core system services.</span></span><br><span class="line">on late-init</span><br><span class="line">   trigger early-fs</span><br><span class="line"><span class="meta">   #</span><span class="bash"> Mount fstab <span class="keyword">in</span> init.&#123;<span class="variable">$device</span>&#125;.rc by mount_all <span class="built_in">command</span>. Optional parameter</span></span><br><span class="line"><span class="meta">   #</span><span class="bash"> <span class="string">&#x27;--early&#x27;</span> can be specified to skip entries with <span class="string">&#x27;latemount&#x27;</span>.</span>    </span><br><span class="line"><span class="meta">   #</span><span class="bash"> /system and /vendor must be mounted by the end of the fs stage,</span>    </span><br><span class="line"><span class="meta">   #</span><span class="bash"> <span class="keyword">while</span> /data is optional.</span></span><br><span class="line">   trigger fs</span><br><span class="line">   trigger post-fs</span><br><span class="line">   </span><br><span class="line"><span class="meta">   #</span><span class="bash"> Mount fstab <span class="keyword">in</span> init.&#123;<span class="variable">$device</span>&#125;.rc by mount_all with <span class="string">&#x27;--late&#x27;</span> parameter</span>    </span><br><span class="line"><span class="meta">   #</span><span class="bash"> to only mount entries with <span class="string">&#x27;latemount&#x27;</span>. This is needed <span class="keyword">if</span> <span class="string">&#x27;--early&#x27;</span> is</span>    </span><br><span class="line"><span class="meta">   #</span><span class="bash"> specified <span class="keyword">in</span> the previous mount_all <span class="built_in">command</span> on the fs stage.</span></span><br><span class="line"><span class="meta">   #</span><span class="bash"> With /system mounted and properties form /system + /factory available,</span>    </span><br><span class="line"><span class="meta">   #</span><span class="bash"> some services can be started.</span></span><br><span class="line">   trigger late-fs</span><br><span class="line"><span class="meta">   #</span><span class="bash"> Now we can mount /data. File encryption requires keymaster to decrypt</span>    </span><br><span class="line"><span class="meta">   #</span><span class="bash"> /data, <span class="built_in">which</span> <span class="keyword">in</span> turn can only be loaded when system properties are present.</span></span><br><span class="line">   trigger post-fs-data</span><br><span class="line"><span class="meta">   #</span><span class="bash"> Now we can start zygote <span class="keyword">for</span> devices with file based encryption</span></span><br><span class="line">   </span><br><span class="line">   trigger zygote-start #zygote-start 是在on late-init 中触发的。</span><br><span class="line"><span class="meta">   #</span><span class="bash"> Load persist properties and override properties (<span class="keyword">if</span> enabled) from /data.</span></span><br><span class="line">   trigger load_persist_props_action</span><br><span class="line"><span class="meta">   #</span><span class="bash"> Remove a file to wake up anything waiting <span class="keyword">for</span> firmware.</span></span><br><span class="line">   trigger firmware_mounts_complete</span><br><span class="line">   trigger early-boot</span><br><span class="line">   trigger boot</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bootmode == <span class="string">&quot;charger&quot;</span>) &#123;</span><br><span class="line">    am.QueueEventTrigger(<span class="string">&quot;charger&quot;</span>);    </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    am.QueueEventTrigger(<span class="string">&quot;late-init&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不是充电模式，就触发late-init，最后触发start zygote。</p>
<p><strong>app_processXX位置\frameworks\base\cmds\app_process目录下</strong>。</p>
<h5 id="4-3-zygote启动代码分析"><a href="#4-3-zygote启动代码分析" class="headerlink" title="4.3 zygote启动代码分析"></a>4.3 zygote启动代码分析</h5><blockquote>
<p>位置\frameworks\base\cmds\app_process\app_main.cpp<br>在app_main.cpp的main函数中，主要做的事情就是参数解析. 这个函数有两种启动模式：</p>
<ol>
<li>一种是zygote模式，也就是初始化zygote进程，传递的参数有–start-system-server –socket- name=zygote，前者表示启动SystemServer，后者指定socket的名称</li>
<li>一种是application模式，也就是启动普通应用程序，传递的参数有class名字以及class带的参数<br>两者最终都是调用AppRuntime对象的start函数，加载ZygoteInit或RuntimeInit两个Java类，并将之前 整理的参数传入进去</li>
</ol>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \frameworks\base\cmds\app_process\app_main.cpp main()  L280 </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--zygote&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果rc脚本传入的--zygote参数，就将zygote设置为true。</span></span><br><span class="line">        zygote = <span class="literal">true</span>;</span><br><span class="line">        niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--start-system-server&quot;</span>) == <span class="number">0</span>) &#123;            </span><br><span class="line">        startSystemServer = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--application&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        application = <span class="literal">true</span>;      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">      <span class="comment">//这些Java的应用都是通过AppRuntime.start（className)开始的</span></span><br><span class="line">      <span class="comment">//其实AppRuntime是AndroidRuntime的子类，它主要实现了几个回调函数，而start()方法是实现在AndroidRuntime这个方法类里</span></span><br><span class="line">       runtime.start(<span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);    </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">       runtime.start(<span class="string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);    </span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/10058d760200">Jack Ou</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/10058d760200">https://www.jianshu.com/u/10058d760200</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">此文章版权归Jack Ou所有，如有转载，请註明来自原作者</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Framework/">Framework</a><a class="post-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8/">系统启动</a></div><div class="post_share"><div class="social-share" data-image="https://upload-images.jianshu.io/upload_images/13838098-709a95ad43e716d4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://upload-images.jianshu.io/upload_images/13838098-2431fc1f0eb1b702.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank"><img class="post-qr-code-img" src="https://upload-images.jianshu.io/upload_images/13838098-2431fc1f0eb1b702.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://upload-images.jianshu.io/upload_images/13838098-ea2cb9b10bc2f743.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank"><img class="post-qr-code-img" src="https://upload-images.jianshu.io/upload_images/13838098-ea2cb9b10bc2f743.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/09/28/%E4%BD%BF%E7%94%A8tcpdump%E9%87%87%E9%9B%86%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BD%BF%E7%94%A8wireshark%E6%9F%A5%E7%9C%8B/"><img class="prev-cover" src="https://upload-images.jianshu.io/upload_images/13838098-b688791bf19f1b61.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">使用tcpdump采集网络请求，使用wireshark查看</div></div></a></div><div class="next-post pull-right"><a href="/2021/09/25/Binder%E5%AD%90%E7%B3%BB%E7%BB%9F-%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E7%AF%87/"><img class="next-cover" src="https://upload-images.jianshu.io/upload_images/13838098-68e128c62e879dbb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Binder子系统-注册服务和获取服务篇</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/09/22/Binder子系统-驱动分析篇/" title="Binder子系统-驱动分析篇"><img class="cover" src="https://upload-images.jianshu.io/upload_images/13838098-68e128c62e879dbb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-22</div><div class="title">Binder子系统-驱动分析篇</div></div></a></div><div><a href="/2021/09/25/Binder子系统-ServiceManager篇/" title="Binder子系统-ServiceManager篇"><img class="cover" src="https://upload-images.jianshu.io/upload_images/13838098-68e128c62e879dbb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-25</div><div class="title">Binder子系统-ServiceManager篇</div></div></a></div><div><a href="/2021/09/25/Binder子系统-注册服务和获取服务篇/" title="Binder子系统-注册服务和获取服务篇"><img class="cover" src="https://upload-images.jianshu.io/upload_images/13838098-68e128c62e879dbb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-25</div><div class="title">Binder子系统-注册服务和获取服务篇</div></div></a></div><div><a href="/2021/09/02/应用和服务裁剪-系统优化/" title="应用和服务裁剪--系统优化"><img class="cover" src="https://upload-images.jianshu.io/upload_images/13838098-e1177de6d391bef7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-02</div><div class="title">应用和服务裁剪--系统优化</div></div></a></div><div><a href="/2021/01/29/IPC机制-三-ContentProvider、Socket和Binder池/" title="IPC机制(三) -- ContentProvider、Socket和Binder池"><img class="cover" src="https://upload-images.jianshu.io/upload_images/13838098-1a87ca0aa39d75c2.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-29</div><div class="title">IPC机制(三) -- ContentProvider、Socket和Binder池</div></div></a></div><div><a href="/2021/01/28/IPC机制-二-Bundle-文件共享-Messager/" title="IPC机制(二) -- Bundle,文件共享,Messager"><img class="cover" src="https://upload-images.jianshu.io/upload_images/13838098-cb14d87e1b87a615.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-28</div><div class="title">IPC机制(二) -- Bundle,文件共享,Messager</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://upload-images.jianshu.io/upload_images/13838098-a7dfe0e9d3ed649c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Jack Ou</div><div class="author-info__description">All things are difficult before they are easy</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">121</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">88</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://www.jianshu.com/u/10058d760200"><i class="fad fa-sheep"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/oujie123" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://www.jianshu.com/u/10058d760200" target="_blank" title="简书"><i class="fas fa-book-open"></i></a><a class="social-icon" href="https://blog.csdn.net/u010248147" target="_blank" title="CSDN"><i class="fab fa-microblog"></i></a><a class="social-icon" href="mailto:815669856@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎收看我的博客，很高兴与您一同成长！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Android%E7%B3%BB%E7%BB%9F%E5%A4%A7%E8%87%B4%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">1.Android系统大致启动流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%90%AF%E5%8A%A8init%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2.启动init进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%A7%A3%E6%9E%90init-rc"><span class="toc-number">3.</span> <span class="toc-text">3.解析init.rc</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-Action"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 Action</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-Service"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-Command"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Command</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-Options"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 Options</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-%E9%80%90%E8%A1%8C%E8%A7%A3%E6%9E%90%E8%84%9A%E6%9C%AC"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 逐行解析脚本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-zygote%E5%90%AF%E5%8A%A8"><span class="toc-number">4.</span> <span class="toc-text">4.zygote启动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-Zygote%E7%AE%80%E8%BF%B0"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 Zygote简述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-%E6%AD%A3%E5%BC%8F%E5%90%AF%E5%8A%A8zygote"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 正式启动zygote</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-zygote%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 zygote启动代码分析</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/09/28/%E4%BD%BF%E7%94%A8tcpdump%E9%87%87%E9%9B%86%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BD%BF%E7%94%A8wireshark%E6%9F%A5%E7%9C%8B/" title="使用tcpdump采集网络请求，使用wireshark查看"><img src="https://upload-images.jianshu.io/upload_images/13838098-b688791bf19f1b61.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用tcpdump采集网络请求，使用wireshark查看"/></a><div class="content"><a class="title" href="/2021/09/28/%E4%BD%BF%E7%94%A8tcpdump%E9%87%87%E9%9B%86%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BD%BF%E7%94%A8wireshark%E6%9F%A5%E7%9C%8B/" title="使用tcpdump采集网络请求，使用wireshark查看">使用tcpdump采集网络请求，使用wireshark查看</a><time datetime="2021-09-28T08:49:45.000Z" title="发表于 2021-09-28 16:49:45">2021-09-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/27/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" title="系统进程启动流程分析"><img src="https://upload-images.jianshu.io/upload_images/13838098-709a95ad43e716d4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="系统进程启动流程分析"/></a><div class="content"><a class="title" href="/2021/09/27/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" title="系统进程启动流程分析">系统进程启动流程分析</a><time datetime="2021-09-27T15:35:00.000Z" title="发表于 2021-09-27 23:35:00">2021-09-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/25/Binder%E5%AD%90%E7%B3%BB%E7%BB%9F-%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E7%AF%87/" title="Binder子系统-注册服务和获取服务篇"><img src="https://upload-images.jianshu.io/upload_images/13838098-68e128c62e879dbb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Binder子系统-注册服务和获取服务篇"/></a><div class="content"><a class="title" href="/2021/09/25/Binder%E5%AD%90%E7%B3%BB%E7%BB%9F-%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E7%AF%87/" title="Binder子系统-注册服务和获取服务篇">Binder子系统-注册服务和获取服务篇</a><time datetime="2021-09-25T05:03:18.000Z" title="发表于 2021-09-25 13:03:18">2021-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/25/Binder%E5%AD%90%E7%B3%BB%E7%BB%9F-ServiceManager%E7%AF%87/" title="Binder子系统-ServiceManager篇"><img src="https://upload-images.jianshu.io/upload_images/13838098-68e128c62e879dbb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Binder子系统-ServiceManager篇"/></a><div class="content"><a class="title" href="/2021/09/25/Binder%E5%AD%90%E7%B3%BB%E7%BB%9F-ServiceManager%E7%AF%87/" title="Binder子系统-ServiceManager篇">Binder子系统-ServiceManager篇</a><time datetime="2021-09-24T16:29:17.000Z" title="发表于 2021-09-25 00:29:17">2021-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/22/Binder%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90-%E4%BA%8C/" title="Binder子系统之调试分析(二)"><img src="https://upload-images.jianshu.io/upload_images/13838098-8b17e561a07be52d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Binder子系统之调试分析(二)"/></a><div class="content"><a class="title" href="/2021/09/22/Binder%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90-%E4%BA%8C/" title="Binder子系统之调试分析(二)">Binder子系统之调试分析(二)</a><time datetime="2021-09-21T16:31:06.000Z" title="发表于 2021-09-22 00:31:06">2021-09-22</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://upload-images.jianshu.io/upload_images/13838098-709a95ad43e716d4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Jack Ou</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://oujie123.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.spacingElementById('content-inner')
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.spacingElementById('content-inner')
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="true" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script></div></body></html>